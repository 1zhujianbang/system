# 图谱构建说明文档

本文档将当前项目已落地的图谱能力，按“数据层→图谱层→快照/可视化层”分层说明，并给出每一层的字段定义与上/下游依赖关系，便于后续做更深的拓展（效应图谱、社区图谱、仿真与反事实等）。

## 1. 总体约束

- SQLite 是权威数据源（主存储）；JSON 为兼容导出；Neo4j 为可选对照/读写后端
- 所有“边/元组”必须带时间：`participants.time`、`relations.time`、`event_edges.time`
- 默认字段必须可回放：通过 `event_mentions/event_observations/relations.evidence_json` 等保留证据引用
- 外部结构化字段只作为校验/对照（例如 `event_signals`），不直接覆盖默认投影字段

## 2. 关键字段与表（SQLite）

### 2.1 基础实体与事件（事实层）

- `entities`
  - `entity_id`：TEXT PRIMARY KEY
  - `name`：TEXT UNIQUE
  - `first_seen/last_seen`：TEXT（ISO8601）
  - `sources_json`：TEXT（JSON list）
  - `original_forms_json`：TEXT（JSON list）
- `events`
  - `event_id`：TEXT PRIMARY KEY
  - `abstract`：TEXT UNIQUE（事件摘要唯一键）
  - `event_summary`：TEXT（默认摘要）
  - `event_types_json`：TEXT（JSON list）
  - `event_start_time/event_start_time_text/event_start_time_precision`：TEXT（默认开始时间及其可解释表示）
  - `reported_at/first_seen/last_seen`：TEXT（ISO8601）
  - `sources_json`：TEXT（JSON list）
- `participants`（实体参与事件，强制带 time）
  - `event_id/entity_id`：TEXT（外键）
  - `roles_json`：TEXT（JSON list，实体在事件中的语义角色）
  - `time/reported_at`：TEXT（ISO8601）
- `relations`（实体-实体关系三元组，强制带 time）
  - `event_id`：TEXT（该关系出现于哪个事件上下文）
  - `subject_entity_id/predicate/object_entity_id`
  - `relation_kind`：TEXT（`state|event`；用于“关系是稳定语义还是事件性动作”的区分）
  - `time/reported_at`：TEXT（ISO8601）
  - `evidence_json`：TEXT（JSON list，用于可回放证据）

### 2.2 事件演化与外部对照（扩展层）

- `event_edges`（事件-事件演化边）
  - `from_event_id/to_event_id`
  - `edge_type`：TEXT（例如 follows/responds_to/escalates/causes/related）
  - `time/reported_at`：TEXT（ISO8601）
  - `confidence`：REAL（客观或可解释来源的置信程度；默认 0）
  - `evidence_json`：TEXT（JSON list）
  - `decision_input_hash`：TEXT（可回放输入哈希）
- `event_signals`（外部结构化对照信号，校验用）
  - `sql_date/goldstein_scale/num_mentions/event_code/quad_class/avg_tone` 等
  - `source_json`：TEXT（来源信息）
  - `confidence/updated_at`

### 2.3 默认投影与动态演化（演化层）

- `event_observations`（事件观测层：默认字段投影与审计）
  - `observation_id`：TEXT PRIMARY KEY
  - `event_id/field`
  - `value_text/value_json`：TEXT（JSON 字符串）
  - `evidence_json`：TEXT（JSON list，至少应可关联到 mention/quote）
  - `model_name/model_version/algorithm/revision/is_default/created_at/updated_at`
- `relation_states`（关系状态时间片：用于动态演化回放）
  - `relation_state_id`：TEXT PRIMARY KEY
  - `subject_entity_id/predicate/object_entity_id`
  - `relation_kind`：TEXT（`state|event`）
  - `valid_from/valid_to`：TEXT（ISO8601；`valid_to=''` 表示持续中）
  - `state_text`：TEXT（过程性、无立场描述）
  - `evidence_json`：TEXT（JSON list）
  - `algorithm/revision/is_default/created_at/updated_at`

## 3. 图谱层级结构（已落地能力）

下述“图谱”是对同一份 SQLite 权威数据的不同投影；它们之间存在严格的上/下层依赖。

### 3.1 实体-事件关系图谱（基础层）

目标问题：回答“谁在何时何地对谁做了什么”（以事件为知识单元）。

- 核心模式：
  - `(实体, 角色, 事件)`，或事件多元组：`事件(角色₁: 实体₁, 角色₂: 实体₂, ...)`
- 节点：
  - 实体节点：来自 `entities`
  - 事件节点：来自 `events`
- 边：
  - 参与边：`Entity -[roles]-> Event`，来自 `participants.roles_json/time`
- 依赖：
  - 直接依赖 `entities/events/participants`

### 3.2 实体-事件时序图谱（扩展层，GET）

目标问题：回答“某实体在时间上经历了哪些事件，顺序如何”。

- 核心模式：
  - 实体视角时间线：`Entity -> [Event₁, Event₂, ...]`（按时间排序）
- 排序时间：
  - 优先 `events.event_start_time`；缺失/不可用时回退 `participants.time` 或 `events.reported_at/first_seen`
- 依赖：
  - 依赖 3.1 的事实层字段（本质是对 3.1 的时序化视图）

### 3.3 实体-实体关系图谱（扩展层，EE）

目标问题：回答“实体之间存在什么语义关系（以及在什么事件上下文中出现）”。

- 核心模式：
  - `(头实体, 关系谓词, 尾实体)`，并携带 `event_id/time/evidence`
- 边（实体-实体）：
  - 来自 `relations`：
    - `predicate`：语义关系
    - `relation_kind`：`state|event`（用于区分稳定语义与事件性动作）
    - `evidence_json`：证据入口
- 依赖：
  - 依赖 3.1 的实体与事件，但边源自 `relations`

### 3.4 实体-实体-事件发展图谱（动态层，EE_EVO）

目标问题：回答“实体之间的关系如何随相关事件序列发生变化”（关系作为随时间变化的状态函数）。

- 核心模式：
  - `关系状态(实体A, 实体B, 时间区间) = F(初始状态, 触发事件序列)`
- 表达方式：
  - 将同一三元组 `(A, predicate, B)` 的演化拆分为若干时间片 `relation_states`
  - 每个时间片都必须可回放（保留 `evidence_json`）且可修订（`revision/is_default`）
- 数据来源：
  - `relations`（事实触发记录，带 `event_id/time/evidence_json/relation_kind`）
  - `event_observations`（为事件提供可解释的默认字段投影与证据）
- 依赖：
  - 依赖 3.3 的关系事实层，向上生成 `relation_states`

### 3.5 事件-事件演化图谱（扩展层，EVENT_EVO）

目标问题：回答“事件之间的演化/因果/响应关系链如何形成”。

- 核心模式：
  - `(事件₁, edge_type, 事件₂)`，并携带 `time/confidence/evidence`
- 数据来源：
  - `event_edges`
- 依赖：
  - 依赖 3.1 的事件节点；边来自 `event_edges`

## 4. 上层与下层依赖关系（总结）

- 事实层（权威记录）：`entities/events/participants/relations`
- 扩展层（结构化补充）：`event_edges`（事件链）、`event_signals`（外部对照）
- 演化层（可回放的默认投影/动态状态）：`event_observations`、`relation_states`

推导方向：

- 事实层 → GET：对事件参与记录做“实体视角”的时间排序与裁剪
- 事实层（relations）+ 观测层（event_observations）→ EE_EVO：生成可回放的关系时间片 `relation_states`
- 事实层（events）→ EVENT_EVO：通过 `event_edges` 形成事件链

## 5. 导出与可视化接口（落地形态）

- 兼容 JSON：
  - `data/entities.json`、`data/abstract_to_event_map.json` 由 SQLite 统一导出（用于历史兼容）
- 快照协议（用于 Web/UI）：
  - 由后端将 SQLite（或 Neo4j）投影为统一快照结构：`meta/nodes/edges`
  - EE_EVO 优先读取 `relation_states(is_default=1)`；缺失时可回退到 `relations` 的分段逻辑

