# 提示词工程（Prompt Engineering）审查与规范

本文档盘点并审查项目内所有提示词工程相关实现，给出当前提示词模板清单、调用链、输入输出约束与维护规范。

## 1. 总览：提示词在哪里、怎么被调用

本项目存在两套“LLM 调用与提示词”路径：

1) **业务工具（tools）路径（主路径）**
- 主要用于：新闻抽取、实体/事件去重、审查（review worker）等
- 典型调用链：
  - 抽取：`src/app/business/extraction.py` → `src/infra/async_utils.py:create_extraction_prompt` → `call_llm_with_retry` → `extract_json_from_llm_response`
  - 去重：`src/app/business/graph_ops.py` 或 `src/infra/async_utils.py` 的 prompt builder → `call_llm_with_retry` → `extract_json_from_llm_response`
  - 审查：`src/app/business/review_ops.py` prompt → `call_llm_with_retry` → `extract_json_from_llm_response`

2) **端口/适配器路径（ports/adapters）**
- 主要用于：`EntityExtractor` / `EventExtractor` 的通用实现（可供 services 层复用）
- 典型调用链：
  - `src/adapters/extraction/llm_extractor.py` 的 `PROMPT_TEMPLATE` → `LLMClient.call` → `extract_json_from_llm_response`
  - `src/adapters/extraction/entity_merge_llm.py` 的 `_create_merge_prompt` → `LLMClient.call` → `extract_json_from_llm_response`

### LLM 调用形态（重要约束）
- 当前提供商实现是把**整段 prompt 作为 user message**发送（没有 system message 分层）：见 `src/adapters/llm/providers.py`。
- 项目对“只输出 JSON”的要求依赖于 prompt 文本本身，以及统一解析器的容错能力。

### 统一 JSON 解析器
- `src/infra/serialization.py:extract_json_from_llm_response`：会剥离 markdown code fence，截取 JSON 对象片段；若解析结果为 list，会包装为 `{"events": list}`。

## 2. 抽取提示词（新闻 → 事件/实体/关系）

### 2.1 主抽取提示词（业务工具路径）
- 入口与消费方：`src/app/business/extraction.py`（函数 `llm_extract_events`）
- 构造函数：`src/infra/async_utils.py:create_extraction_prompt`
- 输出协议（强约束）：**严格返回 JSON**，schema 为：
  - `{"events": [{ abstract, event_types, event_start_time, event_start_time_text, event_start_time_precision, entities, entities_original, entity_roles, relations, event_summary }]}`
- 关键工程点（当前模板已包含）：
  - **实体原子化**：禁止“职务/机构+姓名”粘连，要求拆分为两个实体
  - **entities 与 entities_original 对齐**：主名称与原文表述一一对齐
  - **时间基准 reported_at**：把“昨日/上周三”等相对时间尽量换算成 `event_start_time`，同时保留 `event_start_time_text` 与精度字段
  - **关系三元组约束**：subject/object 必须来自 entities 列表；允许每条关系带 evidence
  - **relation_kind**：模板要求输出 `"state"|"event"`，用于区分持续状态与一次性动作/言语

> 说明：业务侧解析逻辑对 `entity_roles`、`event_types`、`relations` 做了较强容错（例如把 string/非法结构归一化），并会过滤不在 `entities` 的角色 key。

### 2.2 端口/适配器的简化抽取提示词（备用/通用）
- 文件：`src/adapters/extraction/llm_extractor.py`
- `LLMEntityExtractor.PROMPT_TEMPLATE`：抽取命名实体（PERSON/ORG/LOCATION），输出 `{"entities":[...]}`。
- `LLMEventExtractor.PROMPT_TEMPLATE`：抽取事件（abstract/type/time/location/participants），输出 `{"events":[...]}`。
- 现状差异（与主抽取提示词相比）：
  - 模板更“通用”，未包含本项目的实体定义、原子化、实体对齐、关系三元组、事件类型标签细化等约束
  - 更适合作为 demo/通用端口实现，而不是项目主链路的高一致性抽取输出

## 3. 去重/合并提示词（实体/事件）

本项目存在两类“去重/合并”：
- **候选发现/去重（duplicate detection）**：输出成组的“重复项集合”
- **审查决策（review decision）**：输出 merge/evolve/separate 等强决策

### 3.1 实体去重提示词（duplicate_entities）
- 当前实际生效（权威）版本：
  - `src/app/business/graph_ops.py:_prepare_entity_compression_prompt_strict`
  - 调用点：`KnowledgeGraph.compress_with_llm` 与 `KnowledgeGraph.append_only_update`（两处都会调用）
  - 输出 schema：`{"duplicate_entities":[["主实体","别名1",...], ...]}`

- 现存但未被调用的版本（遗留/可对齐）：
  - `src/infra/async_utils.py:create_deduplication_prompt`
  - 目前在代码库中仅定义，未发现直接调用点（因此不会影响当前结果分布）

### 3.2 事件去重提示词（duplicate_events）
- 当前实际生效（权威）版本：
  - `src/app/business/graph_ops.py:_prepare_event_compression_prompt`
  - 调用点：`KnowledgeGraph.compress_with_llm`
  - 输出 schema：`{"duplicate_events":[["事件摘要1","事件摘要2",...], ...]}`
  - 关键约束：只在描述“同一具体事实”时才重复；连续发生/顺承关系不能算重复

- 现存但未被调用的版本（遗留/可对齐）：
  - `src/infra/async_utils.py:create_event_deduplication_prompt`
  - 目前在代码库中仅定义，未发现直接调用点

## 4. 审查（Review）提示词：把最终决策交给 LLM

审查模块的定位是：**候选生成用规则，最终 merge/evolve 决策用 LLM**，并把 LLM 输出存入 SQLite（`review_tasks` / `merge_decisions`）。

### 4.1 实体合并审查（entity_merge_review）
- 文件：`src/app/business/review_ops.py:_entity_merge_review_prompt`
- 输出 schema：
  - `{"merge": true|false, "canonical_name": "...", "confidence": 0.0, "reasons": [...], "evidence": [...] }`
- 关键约束：
  - `merge=true` 仅在高度确定时输出；不确定就 `merge=false`
  - 即使 `merge=false` 也允许给一个推荐名称（可为空字符串）
- 版本号：`PROMPT_VERSION = "review-v1"`

### 4.2 事件合并/演化审查（event_merge_or_evolve_review）
- 文件：`src/app/business/review_ops.py:_event_merge_or_evolve_prompt`
- 输出 schema：
  - `{"decision":"merge"|"evolve"|"separate","canonical_abstract":"","edge_type":"follows|responds_to|escalates|causes|related","confidence":0.0,"reasons":[...],"evidence":[...] }`
- 关键约束：
  - merge：给 canonical_abstract
  - evolve：必须给 edge_type 与证据
  - 不确定：separate

## 5. 实体合并（LLMEntityMergeDecider）提示词（适配器层）

- 文件：`src/adapters/extraction/entity_merge_llm.py`
- 目标：
  - 判断每个实体类型（枚举：自然人/注册公司/政府机构或部门/主权国家或明确行政区/国际组织/重要产品品牌及其型号/其他）
  - 产出可合并分组与主实体选择
- 输出 schema：
  - `{"entity_analysis":[{entity,type,confidence,reasoning},...], "merge_groups":[{primary_entity,duplicate_entities,reason,confidence},...] }`
- 调参：
  - `temperature=0.3`，偏向稳定输出

## 6. GraphRAG 问答增强提示词（面向检索增强）

- 文件：`src/adapters/llm/graphrag_adapter.py:_construct_enhanced_prompt`
- 特点：
  - 把“相关实体/事件/关系”拼成上下文块
  - 指示：若上下文不足，说明原因
  - 未强制 JSON 输出（这是问答型 prompt 的合理选择）

## 7. 维护规范（建议作为项目约束）

### 7.1 Schema 优先
- 每个 prompt 必须在模板内明确输出 schema（JSON keys、类型、必填/可空）。
- 解析侧（`extract_json_from_llm_response`）只负责“提取 JSON”，不应承担业务推断。

### 7.2 允许空输出
- 去重/合并类任务：不确定就输出空数组或 merge=false，避免引入错误合并。

### 7.3 不在代码中硬编码 LLM 输出语义
- 例如 `relation_kind` 属于 LLM 输出字段，业务侧应只做最小归一化/校验，不做基于 predicate 的规则推断。

### 7.4 版本化
- 对会影响结果分布的模板建议增加显式版本号（类似 `review-v1`），并随输出落库，便于回溯。

### 7.5 去重模板收敛
- 当前实体/事件去重在代码上存在“infra 版 + graph_ops 版”两套模板，但实际运行只使用 graph_ops 版；如追求结果稳定与可复现，建议后续删去遗留模板或强制两者内容保持一致，并为去重提示词增加显式版本号。

## 8. 主名映射与合并规则存储（SQLite/JSON）

### 8.1 主名映射表（主名/主摘要）
- 表结构：
  - `entity_main_names(entity_id PRIMARY KEY, main_name UNIQUE, ...)`
  - `event_main_abstracts(event_id PRIMARY KEY, main_abstract UNIQUE, ...)`
  - DDL：`src/adapters/sqlite/schema.py:MAIN_NAME_TABLES_DDL`（并在 `src/adapters/sqlite/store.py:_ensure_db` 里兜底创建/补写）
- 读取优先级（对外展示）：
  - 实体导出与读取使用 `COALESCE(mn.main_name, e.name)`：`src/adapters/sqlite/store.py:export_entities_json`、`get_entity_record_by_name` 等
  - 事件导出与读取使用 `COALESCE(ma.main_abstract, e.abstract)`：`src/adapters/sqlite/store.py:export_abstract_map_json` 等
- 写入现状（重要）：
  - 当前主要在 schema 迁移时做一次性“兜底写入”：把 `entities.name`/`events.abstract` 填到对应 main 表（仅 INSERT OR IGNORE）。
  - 目前未发现业务链路在“LLM 审查 merge 的 canonical_name/canonical_abstract”后自动写回 main 表；合并时更多是把旧名/旧摘要写入 alias 表以保留可检索性。

### 8.2 合并规则（merge rules）
- JSON 规则文件（全局）：`config/entity_merge_rules.json`
  - 读取/应用：
    - `src/app/business/graph_ops.py`：加载并在 `refresh_graph/compress_with_llm/append_only_update` 路径中用于实体规范化与规则优先合并
    - `src/app/business/data_fetch.py`：读取后用于别名/同义扩展（便于匹配与对齐）
  - 写入：
    - `src/app/business/graph_ops.py:_save_merge_rules`：会把 LLM 去重输出沉淀为规则（alias -> primary）
- SQLite 中不存在“合并规则表/拒绝合并规则表”：
  - 当前与合并相关的 SQL 表主要是：
    - `review_tasks` / `merge_decisions`：记录 LLM 审查输入与输出（可追溯 prompt_version）
    - `entity_aliases` / `event_aliases`：记录别名到主 ID 的映射
    - `entity_redirects` / `event_redirects`：记录 from->to 的合并重定向链

### 8.3 拒绝合并（reject merge）
- 当前没有专门的“拒绝合并规则表”或“黑名单表”。
- 负向审查结论（merge=false / decision=separate）会落在 `merge_decisions`，但候选生成链路目前不读取这些记录来做“永久跳过”。

### 8.4 名称解析与重定向（读路径）
- 实体 name → entity_id 解析优先级：
  - `entity_main_names.main_name` → `entities.name` → `entity_aliases.alias` → `entity_redirects` 链式解析：`src/adapters/sqlite/store.py:resolve_entity_id_by_name`
- 事件 abstract → event_id 解析优先级：
  - `event_main_abstracts.main_abstract` → `events.abstract` → `event_aliases.abstract` → `event_redirects` 链式解析：`src/adapters/sqlite/store.py:resolve_event_id_by_abstract`

## 9. 其他可落地改进项（当前仅建议，不改代码）
- 去重提示词版本化：为 graph_ops 的去重模板加 PROMPT_VERSION，并把调用元信息落库/写入规则文件，便于回溯结果分布。
- 候选去重与“拒绝合并记忆”：enqueue 阶段读取 `merge_decisions` 中相同 input_hash 的历史结论（merge=false / separate），避免重复入队同一对候选。
- 主名写回：在应用审查合并时，把 `canonical_name/canonical_abstract` 写入 `entity_main_names/event_main_abstracts`（目前只写 alias/redirect，不会自动更新 main 表）。
- 去重模板收敛：删除或冻结 `src/infra/async_utils.py` 内未被调用的去重模板，避免后续误用导致分布漂移。
- 追加模式限流：`append_only_update` 内部的 LLM 去重目前未使用 limiter，可改为读取 settings 的全局 QPS 限制以稳定运行。

## 10. 代码索引（快速跳转）

- 主抽取 prompt：`src/infra/async_utils.py:create_extraction_prompt`
- 实体/事件去重 prompt（infra）：`src/infra/async_utils.py:create_deduplication_prompt`、`create_event_deduplication_prompt`
- 实体/事件去重 prompt（graph_ops）：`src/app/business/graph_ops.py:_prepare_entity_compression_prompt_strict`、`_prepare_event_compression_prompt`
- 审查 prompt：`src/app/business/review_ops.py:_entity_merge_review_prompt`、`_event_merge_or_evolve_prompt`
- 适配器抽取 prompt：`src/adapters/extraction/llm_extractor.py`
- 实体合并决策 prompt：`src/adapters/extraction/entity_merge_llm.py:_create_merge_prompt`
- GraphRAG prompt：`src/adapters/llm/graphrag_adapter.py:_construct_enhanced_prompt`
- JSON 解析：`src/infra/serialization.py:extract_json_from_llm_response`
